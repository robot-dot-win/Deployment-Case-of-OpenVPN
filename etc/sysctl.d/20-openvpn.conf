# OpenVPN服务器Linux内核参数优化调整systemd-sysctl配置文件，2026-02-16
# 注：经Gemini优化
#
# 版权所有：Copyright (C) 2024, Martin Young <martin_young@live.cn>
#
# 测试环境：CentOS Stream 9，8G内存，禁用IPv6
# 文件路径：/etc/sysctl.d/20-openvpn.conf
#
# 适用场景：不超过4k数量用户并发连接
#------------------------------------------------------------------------

# --- [1] 内存水位保护 ---
# 预留 128MB 核心内存，防止高负载下系统因申请不到内存而卡死
vm.min_free_kbytes = 131072
vm.swappiness = 10

# --- [2] 基础网络与转发 (必须) ---
net.ipv4.ip_forward = 1
# 处理 1800+ 客户端 UDP 汇聚流量，防止网卡接收队列溢出
net.core.netdev_max_backlog = 10000
# 增加监听队列，应对重连风暴
net.core.somaxconn = 8192

# --- [3] 核心套接字缓冲区 (针对 UDP 模式非常重要) ---
# 给 OpenVPN 留出足够的系统缓冲区读取数据，防止在高负载下丢弃 UDP 包
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
# TCP 读写缓冲区自动调优上限
net.ipv4.tcp_rmem = 4096 131072 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# --- [4] 邻居表优化 (针对 1800+ 并发设备的关键项) ---
# 防止出现 "Neighbour table overflow" 导致无法分配内部 IP
net.ipv4.neigh.default.gc_thresh1 = 1024
net.ipv4.neigh.default.gc_thresh2 = 2048
net.ipv4.neigh.default.gc_thresh3 = 4096

# --- [5] 拥塞控制与 MTU 探测 ---
# 开启 BBR，改善丢包环境下的 VPN 性能
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
# 开启 TCP MTU 探测，配合mssfix，解决链路挂起问题
net.ipv4.tcp_mtu_probing = 1

# --- [6] 保持连接稳定性 ---
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_fin_timeout = 20
